name: Tweet Temperature of Laguna Verde

on:
  schedule:
    - cron: '*/30 * * * *'  # Cada 30 minutos
  workflow_dispatch:  # Permite ejecutarlo manualmente

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Fetch Temperature from API
        id: fetch_temp
        run: |
          API_URL="https://nginx-cms.onrender.com/api/scraper"
          TEMP=$(curl -s "$API_URL" | jq -r '.res.temperature' | xargs) # Extraer temperatura
          echo "TEMP=$TEMP" >> $GITHUB_ENV

      - name: Post Tweet
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          echo "Publicando tweet..."
          echo "🌡️ La temperatura actual en Laguna Verde es de ${TEMP} #LagunaVerde #Clima" > tweet.txt
          
          pip install twython
          
          python - <<EOF
          from twython import Twython
          import os

          api_key = os.getenv('TWITTER_API_KEY')
          api_secret = os.getenv('TWITTER_API_SECRET')
          access_token = os.getenv('TWITTER_ACCESS_TOKEN')
          access_secret = os.getenv('TWITTER_ACCESS_SECRET')

          twitter = Twython(api_key, api_secret, access_token, access_secret)

          with open('tweet.txt', 'r') as f:
              tweet_text = f.read().strip()

          twitter.update_status(status=tweet_text)
          print("Tweet enviado:", tweet_text)
          EOF
